const T_EPSILON=5e-8;var Collision=function(){this.reset=function(){this.t=1/0},this.copy=function(t){this.t=t.t,this.nVelX=t.nVelX,this.nVelY=t.nVelY},this.getNewX=function(t,i){return this.t>5e-8?t+i*(this.t-5e-8):t},this.getNewY=function(t,i){return this.t>5e-8?t+i*(this.t-5e-8):t},this.getImpactX=function(t,i){return t+i*this.t},this.getImpactY=function(t,i){return t+i*this.t},this.reset()},CollisionPhysics=new function(){this.temp=new Collision,this.pointIntersectsRectangleOuter=function(t,i,e,s){s.reset(),this.pointIntersectsLineVertical(t,i.x2,e,this.temp),this.temp.t<s.t&&s.copy(this.temp),this.pointIntersectsLineVertical(t,i.x1,e,this.temp),this.temp.t<s.t&&s.copy(this.temp),this.pointIntersectsLineHorizontal(t,i.y1,e,this.temp),this.temp.t<s.t&&s.copy(this.temp),this.pointIntersectsLineHorizontal(t,i.y2,e,this.temp),this.temp.t<s.t&&s.copy(this.temp)},this.pointIntersectsLineVertical=function(t,i,e,s){if(s.reset(),0!=t.velX||0!=(t.velR||0)){var n=(i>t.x?i-t.x-t.radius:i-t.x+t.radius)/(t.velX+t.velR);n>0&&n<=e&&(s.t=n,s.nVelX=-t.velX,s.nVelY=t.velY)}},this.pointIntersectsLineHorizontal=function(t,i,e,s){if(s.reset(),0!=t.velY||0!=(t.velR||0)){var n=(i>t.y?i-t.y-t.radius:i-t.y+t.radius)/(t.velY+t.velR);n>0&&n<=e&&(s.t=n,s.nVelX=t.velX,s.nVelY=-t.velY)}},this.pointIntersectsMovingPoint=function(t,i,e,s,n){s.reset(),n.reset();var l=this.pointIntersectsMovingPointDetection(t,i);l>0&&l<=e&&this.pointIntersectsMovingPointResponse(t,i,s,n,l)},this.pointIntersectsMovingPointDetection=function(t,i){var e=t.x-i.x,s=t.y-i.y,n=t.radius+i.radius,l=t.velX-i.velX,a=t.velY-i.velY,o=t.velR+i.velR,r=l*l,h=a*a,c=o*o,u=(e*l+s*a-n*o)*(e*l+s*a-n*o)-(r+h-c)*(e*e+s*s-n*n);if(u<0)return 1/0;var v=-(e*l+s*a-n*o),d=r+h-c,p=Math.sqrt(u),f=(v+p)/d,y=(v-p)/d;return f>0&&y>0?Math.min(f,y):f>0?f:y>0?y:1/0},this.pointIntersectsMovingPointResponse=function(t,i,e,s,n){e.t=n,s.t=n;var l=e.getImpactX(t.x,t.velX),a=e.getImpactY(t.y,t.velY),o=s.getImpactX(i.x,i.velX),r=s.getImpactY(i.y,i.velY),h=Math.atan2(r-a,o-l),c=this.rotate(t.velX,t.velY,h),u=c[0],v=c[1],d=(c=this.rotate(i.velX,i.velY,h))[0],p=c[1];if(u-d<=0)return e.reset(),void s.reset();var f,y,m,g,I=t.radius*t.radius*t.radius,x=i.radius*i.radius*i.radius,M=I-x,R=I+x;f=(M*u+2*x*d)/R,m=(2*I*u-M*d)/R,y=v,g=p,c=this.rotate(f,y,-h),e.nVelX=c[0],e.nVelY=c[1],c=this.rotate(m,g,-h),s.nVelX=c[0],s.nVelY=c[1]},this.rotate=function(t,i,e){var s=Math.sin(e),n=Math.cos(e);return[t*n+i*s,-t*s+i*n]}},newDiv=document.createElement("div");newDiv.id="pong",newDiv.style.width="100%",newDiv.style.height="500px",newDiv.style.backgroundColor="#000",newDiv.style.position="relative";var canvas=document.createElement("canvas");canvas.id="canvas",canvas.style.width="100%",canvas.style.height="100%",newDiv.appendChild(canvas),document.getElementById("primary").insertBefore(newDiv,document.getElementById("primary").children[0]);var ctx=canvas.getContext("2d");function init_canvas(){var t=window.devicePixelRatio||1,i=canvas.getBoundingClientRect();canvas.width=i.width*t,canvas.height=i.height*t,ctx.scale(t,t)}function getMousePos(t,i){var e=t.getBoundingClientRect();return{x:(i.clientX||i.touches[0].clientX)-e.left,y:(i.clientY||i.touches[0].clientY)-e.top}}canvas.onresize=init_canvas;var balls=[],MIN_RADIUS=40,MAX_RADIUS=80,MAX_SPEED=5;const DELTA_R=.01,DELTA_RAD=40;var audioCtx,analyser,freqDataArray,smooth,source,running=!0,Ball=function(t,i){for(this.x=t||Math.random()*canvas.clientWidth,this.y=i||Math.random()*canvas.clientHeight,this.velX=2*Math.random()*MAX_SPEED-MAX_SPEED,this.velY=2*Math.random()*MAX_SPEED-MAX_SPEED,this.colour=Math.random(),this.earliestCollisionResponse=new Collision,this.temp=new Collision,this.me=new Collision,this.other=new Collision,this.ballIntersect=function(t,i){CollisionPhysics.pointIntersectsMovingPoint(this,t,i,this.me,this.other),this.other.t<t.earliestCollisionResponse.t&&t.earliestCollisionResponse.copy(this.other),this.me.t<this.earliestCollisionResponse.t&&this.earliestCollisionResponse.copy(this.me)},this.borderIntersect=function(t){CollisionPhysics.pointIntersectsRectangleOuter(this,{x1:0,x2:canvas.clientWidth,y1:0,y2:canvas.clientHeight},t,this.temp),this.temp.t<this.earliestCollisionResponse.t&&this.earliestCollisionResponse.copy(this.temp)},this.pointCollision=function(t,i,e){return(t-this.x)*(t-this.x)+(i-this.y)*(i-this.y)<(this.radius+e)*(this.radius+e)},this.ballCollision=function(t){return(this.x-t.x)*(this.x-t.x)+(this.y-t.y)*(this.y-t.y)<(this.radius+t.radius)*(this.radius+t.radius)},this.setRadius=function(){var t=this.init_radius-smooth[Math.floor(this.colour*smooth.length)]/255*40;t<5&&(t=5),this.velR=t-this.radius},this.update=function(t){this.velX>MAX_SPEED&&(this.velX=MAX_SPEED),this.velY>MAX_SPEED&&(this.velY=MAX_SPEED),this.earliestCollisionResponse.t<=t?(this.x=this.earliestCollisionResponse.getNewX(this.x,this.velX),this.y=this.earliestCollisionResponse.getNewY(this.y,this.velY),this.velX=this.earliestCollisionResponse.nVelX,this.velY=this.earliestCollisionResponse.nVelY):(this.x+=this.velX*t,this.y+=this.velY*t),this.radius+=this.velR*t,this.earliestCollisionResponse.reset()},this.render=function(){ctx.beginPath(),ctx.arc(this.x,this.y,this.radius,0,2*Math.PI,!1),ctx.fillStyle=colour(this.colour),ctx.fill(),ctx.closePath()},this.canSpawn=function(){var t=!0;for(var i of((this.x<this.radius||this.x>canvas.clientWidth-this.radius||this.y<this.radius||this.y>canvas.clientHeight-this.radius)&&(t=!1),balls))i!=this&&null!=i&&this.ballCollision(i)&&(t=!1);return t},this.radius=MIN_RADIUS+Math.random()*(MAX_RADIUS-MIN_RADIUS);!this.canSpawn();)this.radius-=.01,this.radius<MIN_RADIUS&&delete_ball(this);this.init_radius=this.radius};const EPSILON_TIME=1e-8;function tick(){var t=1;if(analyser.getByteFrequencyData(freqDataArray),smooth=rollingAverage(freqDataArray,100),running){for(var i of balls)null!=i&&i.setRadius();do{for(var e=t,s=0;s<balls.length;s++)for(var n=0;n<balls.length;n++)if(s<n){if(null==balls[s]||null==balls[n])continue;balls[s].ballIntersect(balls[n],e),balls[s].earliestCollisionResponse.t<e&&(e=balls[s].earliestCollisionResponse.t)}for(var i of balls)null!=i&&(i.borderIntersect(t),i.earliestCollisionResponse.t<e&&(e=i.earliestCollisionResponse.t));for(var i of balls)null!=i&&i.update(e);t-=e}while(t>EPSILON_TIME)}for(var i of balls)null!=i&&(i.x-i.radius<0&&(i.x=i.radius+1),i.x+i.radius>canvas.clientWidth&&(i.x=canvas.clientWidth-i.radius-1),i.y-i.radius<0&&(i.y=i.radius+1),i.y+i.radius>canvas.clientHeight&&(i.y=canvas.clientHeight-i.radius-1));render();for(s=0;s<balls.length;s++)null==balls[s]&&balls.splice(s--,1);requestAnimationFrame(tick)}function render(){for(var t of(ctx.clearRect(0,0,canvas.width,canvas.height),balls))null!=t&&t.render()}function delete_ball(t){balls[balls.indexOf(t)]=null}canvas.addEventListener("click",function(t){setup||init_music();var i=getMousePos(canvas,t);for(var e of balls)if(null!=e&&e.pointCollision(i.x,i.y,MIN_RADIUS))return void delete_ball(e);(i.x>MIN_RADIUS&&i.x<canvas.clientWidth-MIN_RADIUS||i.y>MIN_RADIUS&&i.y<canvas.clientHeight-MIN_RADIUS)&&balls.push(new Ball(i.x,i.y))},!1);var setup=!1;function init_music(){setup=!0;try{audioCtx=new AudioContext;var t=document.querySelector("video"),i=audioCtx.createMediaElementSource(t);i.connect(audioCtx.destination),analyser=audioCtx.createAnalyser(),i.connect(analyser),freqDataArray=new Uint8Array(analyser.frequencyBinCount)}catch(t){setup=!1}requestAnimationFrame(tick)}function rollingAverage(t,i){for(var e=[],s=0;s<t.length;s++){for(var n=0,l=0,a=s-Math.floor(i/2);a<s+Math.floor(i/2);a++)t[a]&&(t[a]>0&&(n+=t[a]),l++);l<1&&(l=1),e[s]=n/l}return e}function colour(t){var i=Math.sin(4*t),e=Math.sin(6*t),s=Math.cos(3*t);return`rgb(${i=1.3*i*i*127+100}, ${e=e*e*127+100}, ${s=s*s*127+100})`}init_canvas();