const T_EPSILON=5e-8;var Collision=function(){this.reset=function(){this.t=1/0},this.copy=function(t){this.t=t.t,this.nVelX=t.nVelX,this.nVelY=t.nVelY},this.getNewX=function(t,e){return this.t>5e-8?t+e*(this.t-5e-8):t},this.getNewY=function(t,e){return this.t>5e-8?t+e*(this.t-5e-8):t},this.getImpactX=function(t,e){return t+e*this.t},this.getImpactY=function(t,e){return t+e*this.t},this.reset()},CollisionPhysics=new function(){this.temp=new Collision,this.pointIntersectsRectangleOuter=function(t,e,n,i){i.reset(),this.pointIntersectsLineVertical(t,e.x2,n,this.temp,"right"),this.temp.t<i.t&&i.copy(this.temp),this.pointIntersectsLineVertical(t,e.x1,n,this.temp,"left"),this.temp.t<i.t&&i.copy(this.temp),this.pointIntersectsLineHorizontal(t,e.y1,n,this.temp,"top"),this.temp.t<i.t&&i.copy(this.temp),this.pointIntersectsLineHorizontal(t,e.y2,n,this.temp,"bottom"),this.temp.t<i.t&&i.copy(this.temp)},this.pointIntersectsLineVertical=function(t,e,n,i,a){if(i.reset(),0!=t.velX||0!=(t.velR||0)){var s;if("left"==a){if(s=e-t.x+t.radius,t.x-t.radius<e)return}else if("right"==a){if(s=e-t.x-t.radius,t.x+t.radius>e)return}else s=e>t.x?e-t.x-t.radius:e-t.x+t.radius;var r=s/(t.velX+t.velR);r>0&&r<=n&&(i.t=r,i.nVelX=-t.velX,i.nVelY=t.velY)}},this.pointIntersectsLineHorizontal=function(t,e,n,i,a){if(i.reset(),0!=t.velY||0!=(t.velR||0)){var s;if("top"==a){if(s=e-t.y+t.radius,t.y-t.radius<e)return}else if("bottom"==a){if(s=e-t.y-t.radius,t.y+t.radius>e)return}else s=e>t.y?e-t.y-t.radius:e-t.y+t.radius;var r=s/(t.velY+t.velR);r>0&&r<=n&&(i.t=r,i.nVelX=t.velX,i.nVelY=-t.velY)}},this.pointIntersectsMovingPoint=function(t,e,n,i,a){i.reset(),a.reset();var s=this.pointIntersectsMovingPointDetection(t,e);s>0&&s<=n&&this.pointIntersectsMovingPointResponse(t,e,i,a,s)},this.pointIntersectsMovingPointDetection=function(t,e){var n=t.x-e.x,i=t.y-e.y,a=t.radius+e.radius,s=t.velX-e.velX,r=t.velY-e.velY,l=t.velR+e.velR,o=s*s,h=r*r,c=l*l,d=(n*s+i*r-a*l)*(n*s+i*r-a*l)-(o+h-c)*(n*n+i*i-a*a);if(d<0)return 1/0;var p=-(n*s+i*r-a*l),u=o+h-c,v=Math.sqrt(d),m=(p+v)/u,g=(p-v)/u;return m>0&&g>0?Math.min(m,g):m>0?m:g>0?g:1/0},this.pointIntersectsMovingPointResponse=function(t,e,n,i,a){n.t=a,i.t=a;var s=n.getImpactX(t.x,t.velX),r=n.getImpactY(t.y,t.velY),l=i.getImpactX(e.x,e.velX),o=i.getImpactY(e.y,e.velY),h=Math.atan2(o-r,l-s),c=this.rotate(t.velX,t.velY,h),d=c[0],p=c[1],u=(c=this.rotate(e.velX,e.velY,h))[0],v=c[1];if(d-u<=0)return n.reset(),void i.reset();var m,g,f,y,x=t.radius*t.radius*t.radius,b=e.radius*e.radius*e.radius,C=x-b,w=x+b;m=(C*d+2*b*u)/w,f=(2*x*d-C*u)/w,g=p,y=v,c=this.rotate(m,g,-h),n.nVelX=c[0],n.nVelY=c[1],c=this.rotate(f,y,-h),i.nVelX=c[0],i.nVelY=c[1]},this.rotate=function(t,e,n){var i=Math.sin(n),a=Math.cos(n);return[t*a+e*i,-t*i+e*a]}},running=!0,newDiv=document.createElement("div");newDiv.id="pong",newDiv.style.width="100%",newDiv.style.height="500px",newDiv.style.backgroundColor="#000",newDiv.style.position="relative",newDiv.style.borderBottom="10px solid #f9f9f9";var canvas=document.createElement("canvas");canvas.id="canvas",canvas.style.width="100%",canvas.style.height="100%";var playpause=document.createElement("div");function play(t){setup||init_music(),(running=!running)?(playpause.style.borderStyle="double",playpause.style.borderWidth="0px 0 0px 7vh",darken.style.display="none"):(playpause.style.borderStyle="solid",playpause.style.borderWidth="4vh 0 4vh 6vh",darken.style.display="inline-block")}playpause.style="position: absolute;\n\t\t\t\t   right: 1vh;\n\t\t\t\t   top: 1vh;\n\t\t\t\t   background: transparent;\n\t\t\t\t   box-sizing: border-box;\n\t\t\t\t   width: 0;\n\t\t\t\t   height: 8vh;\n\t\t\t\t   border-color: transparent transparent transparent #ffffff;\n\t\t\t\t   transition: 100ms all ease;\n\t\t\t\t   cursor: pointer;\n\t\t\t\t   border-style: double;\n\t\t\t\t   border-width: 0px 0 0px 7vh;",playpause.addEventListener("click",play,!1);var darken=document.createElement("div");darken.style="position: absolute;\n\t\t\t\t display: none;\n\t\t\t\t left: 0px;\n\t\t\t\t top: 0px;\n\t\t\t\t width: calc(100% - 15vh);\n\t\t\t\t height: calc(100% - 15vh);\n\t\t\t\t background-color: #000000bd;\n\t\t\t\t overflow-y: auto;\n\t\t\t\t padding: 5vh 10vh 10vh 5vh;";var style=document.createElement("style");style.type="text/css",style.innerHTML="\n#pong h1, #pong h2, #pong h3, #pong a{\n  font-family: 'Arial';\n  color: white;\n  margin: 0;\n  font-size: 3em;\n}\n#pong h1{\n  margin: 2vh 0 1vh;\n}\n#pong h2{\n  padding-left: 1vh;\n}\n#pong h3{\n  padding-left: 2vh;\n}\n#pong a{\n  display: inline-block;\n  color: white;\n  font-size: 30px;\n  float: right;\n}\n\n#pong .slider {\n  display: inline-block;\n  -webkit-appearance: none;\n  width: 90%;\n  margin: 10px 10px 20px 0;\n  height: 25px;\n  background: #d3d3d3;\n  outline: none;\n  opacity: 0.7;\n  -webkit-transition: .2s;\n  transition: opacity .2s;\n}\n\n#pong .slider:hover {\n  opacity: 1;\n}\n\n#pong .slider::-webkit-slider-thumb {\n  -webkit-appearance: none;\n  appearance: none;\n  width: 25px;\n  height: 25px;\n  background: #4CAF50;\n  cursor: pointer;\n}\n\n#pong .slider::-moz-range-thumb {\n  width: 25px;\n  height: 25px;\n  background: #4CAF50;\n  cursor: pointer;\n}\n\n#pong div::-webkit-scrollbar{\n  display: none;\n}\ndiv#fullscreen {\n\tcursor: pointer;\n\twidth: 8vh;\n\theight: 8vh;\n  \n\tposition: absolute;\n\ttop: 1vh;\n\tright: 10vh;\n\n\tbackground:\n\t\tlinear-gradient(to right, white 1vh, transparent 1vh) 0 0,\n\t\tlinear-gradient(to right, white 1vh, transparent 1vh) 0 100%,\n\t\tlinear-gradient(to left, white 1vh, transparent 1vh) 100% 0,\n\t\tlinear-gradient(to left, white 1vh, transparent 1vh) 100% 100%,\n\t\tlinear-gradient(to bottom, white 1vh, transparent 1vh) 0 0,\n\t\tlinear-gradient(to bottom, white 1vh, transparent 1vh) 100% 0,\n\t\tlinear-gradient(to top, white 1vh, transparent 1vh) 0 100%,\n\t\tlinear-gradient(to top, white 1vh, transparent 1vh) 100% 100%;\n\n\tbackground-repeat: no-repeat;\n\tbackground-size: 2.5vh 2.5vh;\n}\n\ndiv#fullscreen:hover{\n\tbackground:\n\t\tlinear-gradient(to right, white 1.2vh, transparent 1.2vh) 0 0,\n\t\tlinear-gradient(to right, white 1.2vh, transparent 1.2vh) 0 100%,\n\t\tlinear-gradient(to left, white 1.2vh, transparent 1.2vh) 100% 0,\n\t\tlinear-gradient(to left, white 1.2vh, transparent 1.2vh) 100% 100%,\n\t\tlinear-gradient(to bottom, white 1.2vh, transparent 1.2vh) 0 0,\n\t\tlinear-gradient(to bottom, white 1.2vh, transparent 1.2vh) 100% 0,\n\t\tlinear-gradient(to top, white 1.2vh, transparent 1.2vh) 0 100%,\n\t\tlinear-gradient(to top, white 1.2vh, transparent 1.2vh) 100% 100%;\n\t\n\tbackground-repeat: no-repeat;\n\tbackground-size: 3vh 3vh;\n}\n\ncanvas#colour-bar{\n\twidth: 100%;\n}\n",document.getElementsByTagName("head")[0].appendChild(style);var params={};function slider(t){document.getElementById(t.target.id+"_a")&&(document.getElementById(t.target.id+"_a").innerHTML=t.target.value/(t.target.getAttribute("scale")||1)),params[t.target.id]=t.target.value/(t.target.getAttribute("scale")||1),calculate()}darken.innerHTML='\n<h1>Pong Music Visualizer</h1>\n<h2>Min Radius</h2>\n<input type="range" min="0" max="100" value="40" class="slider" id="minRadius">\n<a id="minRadius_a"></a>\n<h2>Max Radius</h2>\n<input type="range" min="0" max="100" value="80" class="slider" id="maxRadius">\n<a id="maxRadius_a"></a>\n<h2>Max Speed</h2>\n<input type="range" min="0" max="80" scale="10" value="50" class="slider" id="maxSpeed">\n<a id="maxSpeed_a"></a>\n<h2>Music Force</h2>\n<input type="range" min="0" max="100" value="40" class="slider" id="music">\n<a id="music_a"></a>\n<h2>Overlap Force</h2>\n<input type="range" min="0" max="20" scale="10" value="10" class="slider" id="overlapForce">\n<a id="overlapForce_a"></a>\n<div id="fullscreen" onclick="fullscreen()"></div>\n\n<h1>Color Bar (RGB)</h1>\n\n<h2>r sin Coefficient</h2>\n<input type="range" min="0" max="100" scale="10" value="40" class="slider" id="rCoeff">\n<a id="rCoeff_a"></a>\n<h2>g sin Coefficient</h2>\n<input type="range" min="0" max="100" scale="10" value="60" class="slider" id="gCoeff">\n<a id="gCoeff_a"></a>\n<h2>b sin Coefficient</h2>\n<input type="range" min="0" max="100" scale="10" value="30" class="slider" id="bCoeff">\n<a id="bCoeff_a"></a>\n\n<h2>RGB Range (0 - 255)</h2>\n<input type="range" min="0" max="255" value="127" class="slider" id="range">\n<a id="range_a"></a>\n<h2>RGB Offset (0 - 255)</h2>\n<input type="range" min="0" max="255" value="100" class="slider" id="offset">\n<a id="offset_a"></a>\n\n<h2>r scale</h2>\n<input type="range" min="0" max="5" value="1" class="slider" id="rScale">\n<a id="rScale_a"></a>\n<h2>r Coefficient</h2>\n<input type="range" min="0" max="100" scale="10" value="13" class="slider" id="rCo">\n<a id="rCo_a"></a>\n\n<h2>g scale</h2>\n<input type="range" min="0" max="10" value="1" class="slider" id="gScale">\n<a id="gScale_a"></a>\n<h2>g Coefficient</h2>\n<input type="range" min="0" max="100" scale="10" value="10" class="slider" id="gCo">\n<a id="gCo_a"></a>\n\n<h2>b scale</h2>\n<input type="range" min="0" max="10" value="1" class="slider" id="bScale">\n<a id="bScale_a"></a>\n<h2>b Coefficient</h2>\n<input type="range" min="0" max="100" scale="10" value="10" class="slider" id="bCo">\n<a id="bCo_a"></a>\n\n<canvas id="colour-bar" width="1000" height="100"></canvas>\n',newDiv.appendChild(canvas),newDiv.appendChild(darken),newDiv.appendChild(playpause),document.getElementById("primary").insertBefore(newDiv,document.getElementById("primary").children[0]);var inputs=document.getElementsByClassName("slider");for(var i of inputs)document.getElementById(i.id+"_a")&&(document.getElementById(i.id+"_a").innerHTML=i.value/(i.getAttribute("scale")||1)),i.addEventListener("input",slider,!1),params[i.id]=i.value/(i.getAttribute("scale")||1);var colorBar=document.getElementById("colour-bar"),barCtx=colorBar.getContext("2d");function calculate(){params.minRadius>params.maxRadius&&(params.minRadius=params.maxRadius),params.music>params.minRadius&&(params.music=params.minRadius);for(var t=0;t<colorBar.width;t++)barCtx.fillStyle=colour(t/colorBar.width),barCtx.fillRect(t,100,1,-20)}function fullscreen(){canvas.webkitRequestFullScreen?canvas.webkitRequestFullScreen():canvas.mozRequestFullScreen(),init_canvas(),play()}calculate();var width,height,ctx=canvas.getContext("2d");function init_canvas(){var t=window.devicePixelRatio||1,e=canvas.getBoundingClientRect();canvas.width=e.width*t,canvas.height=e.height*t,width=e.width,height=e.height,ctx.scale(t,t)}function getMousePos(t,e){var n=t.getBoundingClientRect();return{x:(e.clientX||e.touches[0].clientX)-n.left,y:(e.clientY||e.touches[0].clientY)-n.top}}canvas.onresize=init_canvas;var balls=[];const DELTA_R=.001;var audioCtx,analyser,freqDataArray,smooth,source,Ball=function(t,e){for(this.x=t||Math.random()*canvas.clientWidth,this.y=e||Math.random()*canvas.clientHeight,this.velX=2*Math.random()*params.maxSpeed-params.maxSpeed,this.velY=2*Math.random()*params.maxSpeed-params.maxSpeed,this.colour=Math.random(),this.earliestCollisionResponse=new Collision,this.temp=new Collision,this.me=new Collision,this.other=new Collision,this.ballIntersect=function(t,e){CollisionPhysics.pointIntersectsMovingPoint(this,t,e,this.me,this.other),this.other.t<t.earliestCollisionResponse.t&&t.earliestCollisionResponse.copy(this.other),this.me.t<this.earliestCollisionResponse.t&&this.earliestCollisionResponse.copy(this.me)},this.borderIntersect=function(t){CollisionPhysics.pointIntersectsRectangleOuter(this,{x1:0,x2:canvas.clientWidth,y1:0,y2:canvas.clientHeight},t,this.temp),this.temp.t<this.earliestCollisionResponse.t&&this.earliestCollisionResponse.copy(this.temp)},this.pointCollision=function(t,e,n){return(t-this.x)*(t-this.x)+(e-this.y)*(e-this.y)<(this.radius+n)*(this.radius+n)},this.ballCollision=function(t){return(this.x-t.x)*(this.x-t.x)+(this.y-t.y)*(this.y-t.y)<(this.radius+t.radius)*(this.radius+t.radius)},this.setRadius=function(){var t=this.init_radius-params.music*(smooth[Math.floor(this.colour*smooth.length)]/255);t<5&&(t=5),this.velR=t-this.radius},this.update=function(t){this.velX>params.maxSpeed&&(this.velX=params.maxSpeed),this.velX<-params.maxSpeed&&(this.velX=-params.maxSpeed),this.velY>params.maxSpeed&&(this.velY=params.maxSpeed),this.velY<-params.maxSpeed&&(this.velY=-params.maxSpeed),this.earliestCollisionResponse.t<=t?(this.x=this.earliestCollisionResponse.getNewX(this.x,this.velX),this.y=this.earliestCollisionResponse.getNewY(this.y,this.velY),this.velX=this.earliestCollisionResponse.nVelX,this.velY=this.earliestCollisionResponse.nVelY):(this.x+=this.velX*t,this.y+=this.velY*t),this.radius+=this.velR*t,this.earliestCollisionResponse.reset()},this.render=function(){ctx.beginPath(),ctx.arc(this.x,this.y,this.radius,0,2*Math.PI,!1),ctx.fillStyle=colour(this.colour),ctx.fill(),ctx.closePath()},this.canSpawn=function(){var t=!0;for(var e of((this.x<this.radius||this.x>canvas.clientWidth-this.radius||this.y<this.radius||this.y>canvas.clientHeight-this.radius)&&(t=!1),balls))e!=this&&null!=e&&this.ballCollision(e)&&(t=!1);return t},this.radius=params.minRadius+Math.random()*(params.maxRadius-params.minRadius);!this.canSpawn();)this.radius-=.001,this.radius<params.minRadius&&delete_ball(this);this.init_radius=this.radius};const EPSILON_TIME=1e-8;function tick(){var t=1,e=canvas.getBoundingClientRect();if(width!=e.width&&e.width>200&&init_canvas(),analyser.getByteFrequencyData(freqDataArray),smooth=rollingAverage(freqDataArray,100),running){for(var n of balls)null!=n&&n.setRadius();do{for(var i=t,a=0;a<balls.length;a++)for(var s=0;s<balls.length;s++)if(a<s){if(null==balls[a]||null==balls[s])continue;balls[a].ballIntersect(balls[s],i),balls[a].earliestCollisionResponse.t<i&&(i=balls[a].earliestCollisionResponse.t)}for(var n of balls)null!=n&&(n.borderIntersect(t),n.earliestCollisionResponse.t<i&&(i=n.earliestCollisionResponse.t));for(var n of balls)null!=n&&n.update(i);t-=i}while(t>EPSILON_TIME)}for(var n of balls)if(null!=n){for(var r of balls)if(null!=r&&n!=r&&n.ballCollision(r)){var l=r.x-n.x,o=r.y-n.y,h=l*l+o*o,c=Math.sqrt(h);n.velX+=-l/c*params.overlapForce,n.velY+=-o/c*params.overlapForce}n.x-n.radius<0&&(n.velX+=params.overlapForce),n.x+n.radius>canvas.clientWidth&&(n.velX-=params.overlapForce),n.y-n.radius<0&&(n.velY+=params.overlapForce),n.y+n.radius>canvas.clientHeight&&(n.velY-=params.overlapForce)}render();for(a=0;a<balls.length;a++)null==balls[a]&&balls.splice(a--,1);requestAnimationFrame(tick)}function render(){for(var t of(ctx.clearRect(0,0,canvas.width,canvas.height),balls))null!=t&&t.render();barCtx.clearRect(0,0,colorBar.width,colorBar.height);for(var e=0;e<colorBar.width;e++)barCtx.fillStyle=colour(e/colorBar.width),barCtx.fillRect(e,100,1,-20-80*smooth[Math.floor(e/colorBar.width*smooth.length)]/255)}function delete_ball(t){balls[balls.indexOf(t)]=null}canvas.addEventListener("click",function(t){setup||init_music();var e=getMousePos(canvas,t);for(var n of balls)if(null!=n&&n.pointCollision(e.x,e.y,params.minRadius))return void delete_ball(n);(e.x>params.minRadius&&e.x<canvas.clientWidth-params.minRadius||e.y>params.minRadius&&e.y<canvas.clientHeight-params.minRadius)&&balls.push(new Ball(e.x,e.y))},!1);var setup=!1;function init_music(){setup=!0;try{audioCtx=new AudioContext;var t=document.querySelector("video"),e=audioCtx.createMediaElementSource(t);e.connect(audioCtx.destination),analyser=audioCtx.createAnalyser(),e.connect(analyser),freqDataArray=new Uint8Array(analyser.frequencyBinCount)}catch(t){setup=!1}requestAnimationFrame(tick)}function rollingAverage(t,e){for(var n=[],i=0;i<t.length;i++){for(var a=0,s=0,r=i-Math.floor(e/2);r<i+Math.floor(e/2);r++)t[r]&&(t[r]>0&&(a+=t[r]),s++);s<1&&(s=1),n[i]=a/s}return n}function colour(t){for(var e=Math.sin(params.rCoeff*t),n=Math.sin(params.gCoeff*t),i=Math.cos(params.bCoeff*t),a=0;a<params.rScale;a++)e*=e;for(a=0;a<params.gScale;a++)n*=n;for(a=0;a<params.bScale;a++)i*=i;return`rgb(${e=params.rCo*e*params.range+params.offset}, ${n=params.gCo*n*params.range+params.offset}, ${i=params.bCo*i*params.range+params.offset})`}init_canvas();